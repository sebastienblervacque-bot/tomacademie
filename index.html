<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AcadÃ©mie des Sommets</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #09090b; --card: #18181b; --accent: #3b82f6;
            --success: #10b981; --text: #f4f4f5; --gold: #fbbf24;
            --danger: #ef4444; --border: #27272a;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Poppins', sans-serif; background-color: var(--bg);
            color: var(--text); margin: 0; padding: 0;
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; width: 100%;
        }

        #app-container { 
            width: 100%; max-width: 600px; padding: 1rem; 
            display: flex; flex-direction: column; gap: 1rem;
        }

        .hidden { display: none !important; }

        .card {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 1.5rem; padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            width: 100%;
        }

        h1 { font-size: clamp(1.5rem, 5vw, 2rem); margin: 0 0 0.5rem 0; color: white; }
        h2 { font-size: clamp(1.2rem, 4vw, 1.5rem); margin: 0; }
        p { font-size: 0.95rem; line-height: 1.5; opacity: 0.9; }

        button {
            background: var(--accent); color: white; border: none;
            padding: 1rem; border-radius: 1rem; cursor: pointer;
            font-weight: 600; font-size: 1rem; transition: transform 0.1s;
            width: 100%; margin-top: 0.75rem;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }

        button:active { transform: scale(0.98); opacity: 0.9; }
        .btn-papa { background: #f97316; border-bottom: 4px solid #c2410c; }
        .btn-subject { background: #27272a; text-align: left; border: 1px solid var(--border); justify-content: flex-start; }
        .btn-reset { background: transparent; color: #71717a; font-size: 0.8rem; margin-top: 2rem; border: 1px dashed #333; }

        .xp-bar-container { background: #27272a; height: 12px; border-radius: 6px; overflow: hidden; margin: 1rem 0; }
        .xp-fill { background: linear-gradient(90deg, var(--gold), #f59e0b); width: 0%; height: 100%; transition: 1s ease; }

        .mood-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin: 1rem 0; }
        .mood-btn { font-size: 2.5rem; background: #27272a; border-radius: 1rem; padding: 0.5rem; border: 1px solid var(--border); width: 100%; }

        input {
            width: 100%; padding: 1rem; border-radius: 0.75rem; border: 1px solid var(--border); 
            background: #09090b; color: white; font-size: 1rem; margin-bottom: 0.5rem;
        }

        #game-wrapper { width: 100%; position: relative; margin: 1rem 0; aspect-ratio: 3/4; }
        #game-canvas { 
            background: #000; border-radius: 1rem; border: 2px solid var(--gold); 
            width: 100%; height: 100%; touch-action: none; 
        }

        #file-preview img { width: 100%; border-radius: 1rem; margin-top: 1rem; border: 1px solid var(--accent); }
    </style>
</head>
<body>

<div id="app-container">
    <div id="screen-setup" class="card hidden">
        <h1>L'AcadÃ©mie</h1>
        <p>PrÃªt pour ton ascension ?</p>
        <input type="text" id="in-name" placeholder="Ton prÃ©nom">
        <button onclick="saveProfile()">Commencer la mission ğŸš€</button>
    </div>

    <div id="screen-mood" class="card hidden" style="text-align: center;">
        <h2>Salut Champion !</h2>
        <p>Comment te sens-tu aujourd'hui ?</p>
        <div class="mood-grid">
            <button class="mood-btn" onclick="logMood('ğŸš€', 'Ã€ fond !')">ğŸš€</button>
            <button class="mood-btn" onclick="logMood('ğŸ¯', 'Focus')">ğŸ¯</button>
            <button class="mood-btn" onclick="logMood('ğŸ˜´', 'K.O.')">ğŸ˜´</button>
            <button class="mood-btn" onclick="logMood('ğŸ¤”', 'Bof')">ğŸ¤”</button>
        </div>
    </div>

    <div id="screen-goal" class="card hidden">
        <h2>Ton Contrat</h2>
        <p>Combien d'XP vises-tu cette semaine ?</p>
        <input type="number" id="in-goal" placeholder="Ex: 300">
        <button onclick="saveGoal()">Signer mon contrat âœï¸</button>
    </div>

    <div id="screen-main" class="hidden">
        <div class="card">
            <h2 id="txt-greeting">Salut !</h2>
            <p id="txt-mood" style="color: var(--success); font-weight: 600;"></p>
            
            <div style="margin-top: 1.5rem;">
                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; opacity: 0.8;">
                    <span>Objectif hebdo</span>
                    <span><b id="xp-current">0</b> / <b id="goal-val">0</b> XP</span>
                </div>
                <div class="xp-bar-container"><div id="goal-fill" class="xp-fill"></div></div>
            </div>
            
            <button class="btn-papa" onclick="shareWithPapa()">â­ Partager ma rÃ©ussite Ã  Papa</button>
        </div>

        <div style="display: grid; gap: 0.75rem; margin-top: 1rem;">
            <button class="btn-subject" onclick="showSection('section-quiz')"><span>ğŸ“</span> <b>DÃ©fis 5Ã¨me</b></button>
            <button class="btn-subject" onclick="showSection('section-import')"><span>ğŸ“¸</span> <b>Mes Cahiers de cours</b></button>
        </div>

        <button class="btn-reset" onclick="fullReset()">RÃ©initialiser mon compte</button>
    </div>

    <div id="section-quiz" class="section hidden card">
        <h2 style="color:var(--gold); margin-bottom: 1rem;">Missions d'apprentissage</h2>
        <div id="quiz-content">
            <button class="btn-subject" onclick="startQuiz('maths')">ğŸ“ Maths : Relatifs & Fractions</button>
            <button class="btn-subject" onclick="startQuiz('anglais')">ğŸ‡¬ğŸ‡§ Anglais : Le PassÃ©</button>
            <button class="btn-subject" onclick="startQuiz('espagnol')">ğŸ‡ªğŸ‡¸ Espagnol : PrÃ©sent</button>
        </div>
        <button onclick="closeSections()" style="background:#333; margin-top:1.5rem;">â¬…ï¸ Retour</button>
    </div>

    <div id="section-game" class="section hidden card" style="text-align:center;">
        <h2 style="color:var(--gold);">CADEAU !</h2>
        <p>Attrape 10 Ã©toiles !</p>
        <div id="game-wrapper">
            <canvas id="game-canvas" width="300" height="400"></canvas>
        </div>
        <p id="game-score">Score : 0 / 10</p>
        <button onclick="closeSections()" style="background:#333">Quitter le jeu</button>
    </div>

    <div id="section-import" class="section hidden card">
        <h2>BibliothÃ¨que de cours</h2>
        <input type="file" accept="image/*" onchange="handleFile(event)" id="file-up" style="display:none;">
        <button onclick="document.getElementById('file-up').click()" style="background:var(--success)">â• Ajouter une photo de cours</button>
        <div id="file-preview"></div>
        <button onclick="closeSections()" style="background:#333; margin-top:1.5rem;">â¬…ï¸ Retour</button>
    </div>
</div>

<script>
    let state = { name: "", xp: 0, goal: 0, mood: "" };
    let audioCtx = null;

    const dbQuiz = {
        maths: [
            { q: "Calcule : $(-15) + (+6)$", a: ["-9", "-21", "9"], correct: 0 },
            { q: "Simplifie $\\frac{14}{21}$", a: ["2/3", "7/3", "1/2"], correct: 0 }
        ],
        anglais: [
            { q: "PrÃ©tÃ©rit de 'BUY' (Acheter) :", a: ["Buyed", "Bought", "Boughten"], correct: 1 },
            { q: "Traduction de 'I was' :", a: ["J'Ã©tais", "Je suis", "Je serai"], correct: 0 }
        ],
        espagnol: [
            { q: "Comment dit-on 'La cuisine' ?", a: ["La cocina", "El dormitorio", "La sala"], correct: 0 },
            { q: "Yo ____ (TENER) doce aÃ±os.", a: ["Tengo", "Tienes", "Tiene"], correct: 0 }
        ]
    };

    // --- SONS SYNTHÃ‰TISÃ‰S ---
    function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }

    function playSound(type) {
        if(!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        
        const now = audioCtx.currentTime;
        if(type === 'correct') {
            osc.frequency.setValueAtTime(523.25, now); // C5
            osc.frequency.exponentialRampToValueAtTime(880, now + 0.1); // A5
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(); osc.stop(now + 0.3);
        } else if (type === 'victory') {
            [523, 659, 783, 1046].forEach((f, i) => {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.value = f;
                g.gain.setValueAtTime(0.1, now + (i*0.1));
                g.gain.exponentialRampToValueAtTime(0.01, now + (i*0.1) + 0.4);
                o.start(now + (i*0.1)); o.stop(now + (i*0.1) + 0.4);
            });
        }
    }

    window.onload = () => {
        const saved = localStorage.getItem('sommets_v5');
        if (saved) { state = JSON.parse(saved); showMoodScreen(); }
        else { document.getElementById('screen-setup').classList.remove('hidden'); }
    };

    function saveProfile() {
        initAudio();
        state.name = document.getElementById('in-name').value;
        if (!state.name) return;
        saveData(); showMoodScreen();
    }

    function showMoodScreen() { hideAll(); document.getElementById('screen-mood').classList.remove('hidden'); }

    function logMood(emoji, txt) {
        initAudio();
        state.mood = emoji + " " + txt;
        if (state.goal > 0) showDashboard();
        else { hideAll(); document.getElementById('screen-goal').classList.remove('hidden'); }
    }

    function saveGoal() {
        state.goal = parseInt(document.getElementById('in-goal').value);
        if (state.goal > 0) { saveData(); showDashboard(); }
    }

    function showDashboard() {
        hideAll();
        document.getElementById('screen-main').classList.remove('hidden');
        document.getElementById('txt-greeting').innerText = `En avant, ${state.name} !`;
        document.getElementById('txt-mood').innerText = `Humeur : ${state.mood}`;
        refreshUI();
    }

    function refreshUI() {
        document.getElementById('xp-current').innerText = state.xp;
        document.getElementById('goal-val').innerText = state.goal;
        let progress = (state.xp / state.goal) * 100;
        document.getElementById('goal-fill').style.width = Math.min(progress, 100) + "%";
        saveData();
    }

    function startQuiz(sub) {
        const qData = dbQuiz[sub][Math.floor(Math.random() * dbQuiz[sub].length)];
        let html = `<h3 style="margin-bottom:1.5rem;">${qData.q}</h3>`;
        qData.a.forEach((opt, i) => {
            html += `<button class="btn-subject" onclick="checkAnswer(${i}, ${qData.correct})">${opt}</button>`;
        });
        document.getElementById('quiz-content').innerHTML = html;
    }

    function checkAnswer(chosen, correct) {
        if (chosen === correct) {
            playSound('correct');
            state.xp += 50; refreshUI();
            showSection('section-game'); initGame();
        } else {
            alert("RÃ©essaie encore, tu chauffes !");
        }
        document.getElementById('quiz-content').innerHTML = `
            <button class="btn-subject" onclick="startQuiz('maths')">ğŸ“ Maths</button>
            <button class="btn-subject" onclick="startQuiz('anglais')">ğŸ‡¬ğŸ‡§ Anglais</button>
            <button class="btn-subject" onclick="startQuiz('espagnol')">ğŸ‡ªğŸ‡¸ Espagnol</button>`;
    }

    function shareWithPapa() {
        const msg = `Salut Papa ! Je me sens ${state.mood}. J'ai atteint ${state.xp} XP sur mon objectif de ${state.goal} ! ğŸ”ï¸`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function showSection(id) { hideAll(); document.getElementById(id).classList.remove('hidden'); }
    function closeSections() { showDashboard(); }
    function hideAll() { document.querySelectorAll('.card, .section').forEach(s => s.classList.add('hidden')); }

    function handleFile(event) {
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('file-preview').innerHTML = `<img src="${e.target.result}" style="width:100%; border-radius:1rem; margin-top:1rem;">`;
        };
        reader.readAsDataURL(event.target.files[0]);
    }

    function fullReset() {
        if (confirm("Voulez-vous vraiment recommencer Ã  zÃ©ro ?")) {
            localStorage.clear(); location.reload();
        }
    }

    function saveData() { localStorage.setItem('sommets_v5', JSON.stringify(state)); }

    function initGame() {
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        let basket = { x: 125, y: 350, w: 50, h: 15 };
        let star = { x: Math.random()*270, y: 0, r: 10, s: 5 };
        let caught = 0;

        function play() {
            ctx.clearRect(0, 0, 300, 400);
            ctx.fillStyle = "#3b82f6"; ctx.fillRect(basket.x, basket.y, basket.w, basket.h);
            ctx.fillStyle = "#fbbf24"; ctx.beginPath(); ctx.arc(star.x, star.y, star.r, 0, 7); ctx.fill();
            star.y += star.s;
            if(star.y > 400) { star.y = 0; star.x = Math.random()*270; }
            if(star.y > basket.y && star.x > basket.x && star.x < basket.x + basket.w) {
                caught++;
                document.getElementById('game-score').innerText = `Score : ${caught} / 10`;
                star.y = 0; star.x = Math.random()*270;
            }
            if(caught < 10) requestAnimationFrame(play);
            else { 
                playSound('victory');
                ctx.fillStyle="white"; ctx.font="20px Poppins"; ctx.fillText("MISSION RÃ‰USSIE !", 60, 200); 
            }
        }

        const move = (e) => {
            let rect = canvas.getBoundingClientRect();
            let touchX = (e.touches ? e.touches[0].clientX : e.clientX);
            let x = (touchX - rect.left) * (300 / rect.width) - basket.w/2;
            basket.x = Math.max(0, Math.min(300 - basket.w, x));
            if(e.touches) e.preventDefault();
        };

        canvas.addEventListener('mousemove', move);
        canvas.addEventListener('touchmove', move, {passive: false});
        play();
    }
</script>
</body>
</html>